name: Deploy TinoTools

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'éƒ¨ç½²åŸå› '
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘éƒ¨ç½²'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: npm ci || npm install
    
    - name: æ„å»ºé¡¹ç›®
      run: npm run build
    
    - name: ä»£ç æ£€æŸ¥
      run: |
        echo "è·³è¿‡ä»£ç æ£€æŸ¥"
        # npm run lint
    
    - name: è®¾ç½®SSHå¯†é’¥
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
        config: |
          Host server
            HostName ${{ secrets.SERVER_HOST }}
            User ${{ secrets.SERVER_USERNAME }}
            IdentityFile ~/.ssh/id_rsa
    
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      run: |
        # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå·²æ³¨é‡Šï¼Œä¸´æ—¶è·³è¿‡ï¼‰
        # ssh server "cd /www/wwwroot/tinotools/main && tar -czf backup-$(date +%Y%m%d%H%M%S).tar.gz . || true"
        
        # åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        ssh server "mkdir -p /www/wwwroot/tinotools/main"
        
        # åŒæ­¥æ„å»ºäº§ç‰©ï¼šä½¿ç”¨ rsync é¿å… scp å¡ä½
        rsync -az --delete -e 'ssh -o StrictHostKeyChecking=no' .next/ server:/www/wwwroot/tinotools/main/.next/
        rsync -az --delete -e 'ssh -o StrictHostKeyChecking=no' public/ server:/www/wwwroot/tinotools/main/public/
        rsync -az -e 'ssh -o StrictHostKeyChecking=no' package.json next.config.js server:/www/wwwroot/tinotools/main/
        
        # åŒæ­¥ä¿é™©äº§å“æ•°æ®æ–‡ä»¶ (JSON)
        rsync -az -e 'ssh -o StrictHostKeyChecking=no' "äº§å“æ¯”è¾ƒæ•°æ®/" server:/www/wwwroot/tinotools/main/äº§å“æ¯”è¾ƒæ•°æ®/
        
        # è¿œç¨‹å®‰è£…ç”Ÿäº§ä¾èµ–ã€é‡ç½®æ–‡ä»¶æƒé™å¹¶é‡å¯æœåŠ¡
        ssh server "cd /www/wwwroot/tinotools/main && npm install --production && find . -type f -exec chmod 644 {} \; && find . -type d -exec chmod 755 {} \; && chown -R nginx:nginx /www/wwwroot/tinotools/main && pm2 restart tino-tools || pm2 start npm --name 'tino-tools' -- start"
        
        # éªŒè¯éƒ¨ç½²
        echo "éªŒè¯éƒ¨ç½²çŠ¶æ€..."
        DEPLOY_CHECK=$(ssh server "ls -la /www/wwwroot/tinotools/main/next.config.js || echo 'Not found'")
        echo "$DEPLOY_CHECK"
        
        if [[ "$DEPLOY_CHECK" != *"Not found"* ]]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥!"
          exit 1
        fi
    
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      if: always()
      run: |
        STATUS="${{ job.status }}"
        if [ "$STATUS" = "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼šTinoToolså·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨(https://tinotools.cn)"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼šè¯·æ£€æŸ¥æ—¥å¿—ç¡®å®šåŸå› "
        fi 