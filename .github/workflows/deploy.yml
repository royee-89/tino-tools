name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
      rollback_version:
        description: 'å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ï¼ˆç•™ç©ºåˆ™éƒ¨ç½²æœ€æ–°ä»£ç ï¼‰'
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬æ ‡è®°
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Generate version info
        id: version
        run: |
          # ä½¿ç”¨æ—¶é—´æˆ³å’Œgitæäº¤å“ˆå¸Œåˆ›å»ºå”¯ä¸€ç‰ˆæœ¬å·
          VERSION=$(date +%Y%m%d%H%M%S)-$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "deploy_time=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "commit_msg=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Send deployment start notification
        uses: ravsamhq/notify-slack-action@v2
        if: always()
        with:
          status: ${{ job.status }}
          notification_title: "ğŸš€ å¼€å§‹éƒ¨ç½² å°åŒ å·¥å…·é›†"
          message_format: "ç‰ˆæœ¬: ${{ steps.version.outputs.version }}\næäº¤ä¿¡æ¯: ${{ steps.version.outputs.commit_msg }}\nä½œè€…: ${{ steps.version.outputs.commit_author }}\næ—¶é—´: ${{ steps.version.outputs.deploy_time }}"
          footer: "å°åŒ å·¥å…·é›†è‡ªåŠ¨éƒ¨ç½²ç³»ç»Ÿ"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || secrets.WECHAT_WEBHOOK_URL || secrets.DINGTALK_WEBHOOK_URL || 'https://example.com' }}
          
      - name: Install dependencies
        run: |
          npm install
        
      - name: Run tests
        run: |
          npm run test || echo "No tests found"
        
      - name: Build project
        if: ${{ !github.event.inputs.rollback_version }}
        run: |
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          echo "export const BUILD_VERSION = '${{ steps.version.outputs.version }}';" > src/lib/version.js
          echo "export const BUILD_DATE = '${{ steps.version.outputs.deploy_time }}';" >> src/lib/version.js
          echo "export const COMMIT_MSG = '${{ steps.version.outputs.commit_msg }}';" >> src/lib/version.js
          echo "export const COMMIT_AUTHOR = '${{ steps.version.outputs.commit_author }}';" >> src/lib/version.js
          
          # æ¸…ç†ç¼“å­˜å¹¶æ„å»º
          rm -rf .next
          npm run build
        env:
          NODE_ENV: production
          
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>&1
          chmod 600 ~/.ssh/known_hosts
          
      - name: Test SSH connection
        run: |
          if ! ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} "echo 'SSH connection successful'"; then
            echo "SSH connection failed"
            exit 1
          fi
          
      - name: Check for rollback
        id: deployment_type
        run: |
          if [ -n "${{ github.event.inputs.rollback_version }}" ]; then
            echo "is_rollback=true" >> $GITHUB_OUTPUT
            echo "rollback_version=${{ github.event.inputs.rollback_version }}" >> $GITHUB_OUTPUT
            echo "âš ï¸ æ‰§è¡Œå›æ»šæ“ä½œåˆ°ç‰ˆæœ¬: ${{ github.event.inputs.rollback_version }}"
          else
            echo "is_rollback=false" >> $GITHUB_OUTPUT
            echo "ğŸš€ æ‰§è¡Œå¸¸è§„éƒ¨ç½²: ${{ steps.version.outputs.version }}"
          fi
          
      - name: Deploy and start application
        id: deploy
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          VERSION: ${{ steps.version.outputs.version }}
          IS_ROLLBACK: ${{ steps.deployment_type.outputs.is_rollback }}
          ROLLBACK_VERSION: ${{ steps.deployment_type.outputs.rollback_version }}
        run: |
          echo "=== Starting deployment process ==="
          DEPLOY_STATUS="success"
          
          if [ "$IS_ROLLBACK" == "true" ]; then
            echo "ğŸ”„ æ‰§è¡Œå›æ»šåˆ°ç‰ˆæœ¬: $ROLLBACK_VERSION"
            
            # æ‰§è¡Œå›æ»šè„šæœ¬
            ssh -p $SERVER_PORT $SERVER_USERNAME@$SERVER_HOST "
              if [ ! -f \"$DEPLOY_PATH/../versions/$ROLLBACK_VERSION.tar.gz\" ]; then
                echo \"é”™è¯¯: å›æ»šç‰ˆæœ¬ $ROLLBACK_VERSION ä¸å­˜åœ¨!\"
                exit 1
              fi
              
              # å¤‡ä»½å½“å‰ç‰ˆæœ¬
              echo 'ğŸ“¦ åˆ›å»ºå½“å‰ç‰ˆæœ¬å¤‡ä»½...'
              mkdir -p \"$DEPLOY_PATH/../versions\"
              if [ -f \"$DEPLOY_PATH/src/lib/version.js\" ]; then
                CURRENT_VERSION=\$(grep BUILD_VERSION \"$DEPLOY_PATH/src/lib/version.js\" | cut -d\"'\" -f2)
                if [ -n \"\$CURRENT_VERSION\" ]; then
                  tar -czf \"$DEPLOY_PATH/../versions/pre-rollback-\$CURRENT_VERSION.tar.gz\" -C \"$DEPLOY_PATH\" .
                fi
              fi
              
              # åœæ­¢å½“å‰åº”ç”¨
              echo 'ğŸ›‘ åœæ­¢åº”ç”¨...'
              pm2 delete tino-tools 2>/dev/null || true
              
              # æ¸…ç†å½“å‰ç›®å½•ï¼Œä¿ç•™node_modules
              echo 'ğŸ§¹ æ¸…ç†ç›®å½•...'
              if [ -d \"$DEPLOY_PATH/node_modules\" ]; then
                mv \"$DEPLOY_PATH/node_modules\" /tmp/tino-tools-node_modules
              fi
              
              rm -rf \"$DEPLOY_PATH\"/* \"$DEPLOY_PATH\"/.[!.]* \"$DEPLOY_PATH\"/..?*
              
              # è§£å‹å›æ»šç‰ˆæœ¬
              echo 'ğŸ“‚ è§£å‹å›æ»šç‰ˆæœ¬...'
              tar -xzf \"$DEPLOY_PATH/../versions/$ROLLBACK_VERSION.tar.gz\" -C \"$DEPLOY_PATH\"
              
              # æ¢å¤node_modules
              if [ -d /tmp/tino-tools-node_modules ]; then
                echo 'â™»ï¸ æ¢å¤node_modules...'
                rm -rf \"$DEPLOY_PATH/node_modules\"
                mv /tmp/tino-tools-node_modules \"$DEPLOY_PATH/node_modules\"
              fi
              
              # ä¿®å¤æƒé™
              chown -R root:root \"$DEPLOY_PATH\"
              chmod -R 755 \"$DEPLOY_PATH\"
              
              # å¯åŠ¨åº”ç”¨
              echo 'ğŸš€ å¯åŠ¨åº”ç”¨...'
              cd \"$DEPLOY_PATH\"
              export NODE_ENV=production
              export PATH=\$PATH:\$(pwd)/node_modules/.bin
              pm2 start npm --name tino-tools -- start
              
              # éªŒè¯å¯åŠ¨çŠ¶æ€
              sleep 10
              if ! pm2 show tino-tools | grep -q 'status.*online'; then
                echo 'âŒ å›æ»šååº”ç”¨å¯åŠ¨å¤±è´¥!'
                exit 1
              fi
              
              echo 'âœ… å›æ»šå®Œæˆ!'
            " || {
              echo "âŒ å›æ»šå¤±è´¥!"
              DEPLOY_STATUS="failed"
            }
            
          else
            echo "ğŸš€ æ‰§è¡Œå¸¸è§„éƒ¨ç½²: $VERSION"
            
            # åˆ›å»ºæ–‡ä»¶åˆ—è¡¨
            echo "ğŸ“‹ åˆ›å»ºéƒ¨ç½²æ–‡ä»¶åˆ—è¡¨..."
            find . -type f -not -path \"./node_modules/*\" -not -path \"./.git/*\" -not -path \"./.github/*\" -not -path \"./.next/cache/*\" > all_files.txt
            
            # ç¡®ä¿åŒ…å«æ‰€æœ‰publicç›®å½•ä¸‹çš„æ–‡ä»¶
            find ./public -type f >> all_files.txt
            sort all_files.txt | uniq > final_files.txt
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            echo "ğŸ” ç¡®è®¤åŒ…å«å…³é”®æ–‡ä»¶:"
            grep -E "logo|favicon|icon" final_files.txt || echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°logoæˆ–faviconæ–‡ä»¶"
            
            # åˆ›å»ºéƒ¨ç½²åŒ…
            echo "ğŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…..."
            tar -czf deploy.tar.gz -T final_files.txt
            
            # ä¸Šä¼ éƒ¨ç½²åŒ…
            echo "ğŸ“¤ ä¸Šä¼ éƒ¨ç½²åŒ…..."
            scp -P $SERVER_PORT deploy.tar.gz $SERVER_USERNAME@$SERVER_HOST:/tmp/deploy-tino-tools.tar.gz || {
              echo "âŒ ä¸Šä¼ éƒ¨ç½²åŒ…å¤±è´¥!"
              DEPLOY_STATUS="failed"
              exit 1
            }
            
            # éƒ¨ç½²åˆ°æœåŠ¡å™¨
            ssh -p $SERVER_PORT $SERVER_USERNAME@$SERVER_HOST "
              set -e
              echo 'ğŸ å¼€å§‹æœåŠ¡å™¨ç«¯éƒ¨ç½²...'
              mkdir -p \"$DEPLOY_PATH\"
              mkdir -p \"$DEPLOY_PATH/../versions\"
              cd \"$DEPLOY_PATH\"
              
              # å¤‡ä»½å½“å‰ç‰ˆæœ¬
              if [ -f \"src/lib/version.js\" ]; then
                echo 'ğŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬...'
                CURRENT_VERSION=\$(grep BUILD_VERSION \"src/lib/version.js\" | cut -d\"'\" -f2)
                if [ -n \"\$CURRENT_VERSION\" ]; then
                  tar -czf \"$DEPLOY_PATH/../versions/\$CURRENT_VERSION.tar.gz\" .
                  # ä¿ç•™æœ€è¿‘10ä¸ªç‰ˆæœ¬
                  ls -t \"$DEPLOY_PATH/../versions\" | grep -v \"$VERSION\" | tail -n +11 | xargs -I {} rm -f \"$DEPLOY_PATH/../versions/{}\"
                fi
              fi
              
              # ä¿å­˜node_modules
              if [ -d node_modules ]; then
                echo 'â™»ï¸ ä¿å­˜node_modules...'
                mv node_modules /tmp/tino-tools-node_modules
              fi
              
              # æ¸…ç†ç›®å½•
              echo 'ğŸ§¹ æ¸…ç†ç›®å½•...'
              rm -rf * .[!.]* ..?*
              
              # è§£å‹æ–°æ–‡ä»¶
              echo 'ğŸ“‚ è§£å‹æ–°æ–‡ä»¶...'
              tar -xzf /tmp/deploy-tino-tools.tar.gz
              rm -f /tmp/deploy-tino-tools.tar.gz
              
              # è¿˜åŸnode_modules
              if [ -d /tmp/tino-tools-node_modules ]; then
                echo 'â™»ï¸ è¿˜åŸnode_modules...'
                rm -rf node_modules
                mv /tmp/tino-tools-node_modules node_modules
              fi
              
              # ä¿®å¤æƒé™
              echo 'ğŸ”§ ä¿®å¤æƒé™...'
              chown -R root:root .
              chmod -R 755 .
              
              # éªŒè¯å…³é”®æ–‡ä»¶
              echo 'ğŸ” éªŒè¯å…³é”®æ–‡ä»¶...'
              if [ ! -f package.json ]; then
                echo 'âŒ é”™è¯¯: package.json æ–‡ä»¶ä¸¢å¤±!'
                exit 1
              fi
              
              # å®‰è£…ä¾èµ–
              echo 'ğŸ“š å®‰è£…ä¾èµ–...'
              npm install
              
              # ä¿å­˜å½“å‰ç‰ˆæœ¬
              echo 'ğŸ’¾ ä¿å­˜å½“å‰ç‰ˆæœ¬: $VERSION...'
              tar -czf \"$DEPLOY_PATH/../versions/$VERSION.tar.gz\" .
              
              # å¯åŠ¨åº”ç”¨
              echo 'ğŸš€ å¯åŠ¨åº”ç”¨...'
              export NODE_ENV=production
              export PATH=\$PATH:\$(pwd)/node_modules/.bin
              export PORT=3000
              export HOST=0.0.0.0
              
              # ç¡®ä¿.nextç›®å½•æƒé™æ­£ç¡®
              if [ -d .next ]; then
                chmod -R 755 .next
              fi
              
              # æ¸…ç†å¯èƒ½çš„ç¼“å­˜æ–‡ä»¶
              find ./public -name '*.gz' -delete 2>/dev/null || true
              find ./public -name '*.br' -delete 2>/dev/null || true
              
              # åœæ­¢å½“å‰æœåŠ¡
              pm2 delete tino-tools 2>/dev/null || true
              
              # å¯åŠ¨æ–°ç‰ˆæœ¬
              pm2 start npm --name tino-tools -- start
              
              # éªŒè¯åº”ç”¨å¯åŠ¨
              echo 'âœ… éªŒè¯åº”ç”¨å¯åŠ¨...'
              sleep 10
              
              if ! pm2 show tino-tools | grep -q 'status.*online'; then
                echo 'âŒ åº”ç”¨å¯åŠ¨å¤±è´¥! æ‰§è¡Œè‡ªåŠ¨å›æ»š...'
                
                if [ -n \"\$CURRENT_VERSION\" ] && [ -f \"$DEPLOY_PATH/../versions/\$CURRENT_VERSION.tar.gz\" ]; then
                  echo 'ğŸ”„ å›æ»šåˆ°ç‰ˆæœ¬: \$CURRENT_VERSION'
                  
                  # åœæ­¢å¤±è´¥çš„åº”ç”¨
                  pm2 delete tino-tools 2>/dev/null || true
                  
                  # æ¸…ç†ç›®å½•
                  rm -rf * .[!.]* ..?*
                  
                  # è§£å‹æ—§ç‰ˆæœ¬
                  tar -xzf \"$DEPLOY_PATH/../versions/\$CURRENT_VERSION.tar.gz\" -C \"$DEPLOY_PATH\"
                  
                  # å¯åŠ¨æ—§ç‰ˆæœ¬
                  export NODE_ENV=production
                  export PATH=\$PATH:\$(pwd)/node_modules/.bin
                  pm2 start npm --name tino-tools -- start
                  
                  echo 'âœ… å›æ»šå®Œæˆï¼Œè¯·æ£€æŸ¥é”™è¯¯æ—¥å¿—'
                  exit 1
                else
                  echo 'âŒ æ— æ³•å›æ»šï¼Œæ‰¾ä¸åˆ°æœ‰æ•ˆçš„å¤‡ä»½ç‰ˆæœ¬!'
                  exit 1
                fi
              fi
              
              echo 'âœ… éƒ¨ç½²æˆåŠŸå®Œæˆ: $VERSION'
            " || {
              echo "âŒ éƒ¨ç½²è„šæœ¬æ‰§è¡Œå¤±è´¥"
              DEPLOY_STATUS="failed"
            }
            
            # æ¸…ç†æœ¬åœ°æ–‡ä»¶
            rm -f deploy.tar.gz all_files.txt final_files.txt
          fi
          
          echo "deploy_status=$DEPLOY_STATUS" >> $GITHUB_OUTPUT
          echo "=== éƒ¨ç½²æµç¨‹å®Œæˆ ==="
          
      - name: Verify deployment
        if: steps.deploy.outputs.deploy_status == 'success'
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "=== éªŒè¯éƒ¨ç½² ==="
          
          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          sleep 5
          
          # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
          if ! ssh -p $SERVER_PORT $SERVER_USERNAME@$SERVER_HOST "cd $DEPLOY_PATH && pm2 show tino-tools | grep -q 'status.*online'"; then
            echo "âŒ é”™è¯¯: åº”ç”¨æœªæ­£å¸¸è¿è¡Œ"
            ssh -p $SERVER_PORT $SERVER_USERNAME@$SERVER_HOST "cd $DEPLOY_PATH && pm2 logs tino-tools --lines 30"
            exit 1
          fi
          
          # è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
          MEMORY_USAGE=$(ssh -p $SERVER_PORT $SERVER_USERNAME@$SERVER_HOST "cd $DEPLOY_PATH && pm2 jlist | grep -o '\"memory\":[0-9]*' | grep -o '[0-9]*'")
          echo "ğŸ“Š åº”ç”¨å†…å­˜ä½¿ç”¨: $MEMORY_USAGE KB"
          
          echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ"
          
      - name: Send deployment notification
        uses: ravsamhq/notify-slack-action@v2
        if: always()
        with:
          status: ${{ job.status }}
          notification_title: "ğŸš€ éƒ¨ç½² ${{ steps.deployment_type.outputs.is_rollback == 'true' && 'å›æ»š' || 'å®Œæˆ' }}: å°åŒ å·¥å…·é›†"
          message_format: "çŠ¶æ€: ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}\nç‰ˆæœ¬: ${{ steps.deployment_type.outputs.is_rollback == 'true' && steps.deployment_type.outputs.rollback_version || steps.version.outputs.version }}\n${{ steps.deployment_type.outputs.is_rollback != 'true' && format('æäº¤ä¿¡æ¯: {0}', steps.version.outputs.commit_msg) || '' }}\n${{ steps.deployment_type.outputs.is_rollback != 'true' && format('ä½œè€…: {0}', steps.version.outputs.commit_author) || 'æ“ä½œ: å›æ»šéƒ¨ç½²' }}\næ—¶é—´: ${{ steps.version.outputs.deploy_time }}"
          footer: "å°åŒ å·¥å…·é›†è‡ªåŠ¨éƒ¨ç½²ç³»ç»Ÿ"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || secrets.WECHAT_WEBHOOK_URL || secrets.DINGTALK_WEBHOOK_URL || 'https://example.com' }} 